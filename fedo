<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FedEx Live Checker v4.0</title>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { 
            backdrop-filter: blur(20px); 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .gradient-text { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #ef4444 100%);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        .success-row { 
            background: linear-gradient(90deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); 
            border-left: 4px solid #10b981;
        }
        .invalid-row { 
            background: linear-gradient(90deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); 
            border-left: 4px solid #ef4444;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.3); }
        }
        .pulse-glow { animation: pulse-glow 2s infinite; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="text-center py-16">
            <div class="inline-flex items-center gap-6 glass rounded-3xl p-10 shadow-2xl max-w-4xl mx-auto">
                <div class="p-6 bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-2xl border-2 border-amber-400/30">
                    <i class="fas fa-truck-loading text-5xl text-amber-400"></i>
                </div>
                <div>
                    <h1 class="text-5xl md:text-6xl font-black gradient-text mb-3 drop-shadow-2xl">FedEx Live Checker</h1>
                    <p class="text-xl md:text-2xl opacity-90 font-medium">Real-time shipment account validation dashboard</p>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- Left: Status + Results -->
            <div class="xl:col-span-2 space-y-8">
                
                <!-- ðŸš€ Live Status -->
                <div class="glass rounded-3xl p-8 shadow-2xl pulse-glow" id="status-section">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-white/10">
                        <h2 class="text-3xl font-black flex items-center gap-4">
                            <i class="fas fa-gauge-high text-amber-400 text-2xl"></i>
                            Live Dashboard
                        </h2>
                        <button hx-get="/api/status" hx-target="#status-metrics" 
                                class="p-3 glass rounded-2xl hover:bg-white/20 transition-all flex items-center gap-2 text-sm font-bold">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="status-metrics" hx-get="/api/status" hx-trigger="load, every 3s" hx-swap="innerHTML" class="space-y-8">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 animate-pulse">
                            <div class="text-center p-8 glass rounded-2xl h-32 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white/10 rounded-xl animate-pulse"></div>
                            </div>
                            <div class="text-center p-8 glass rounded-2xl h-32 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white/10 rounded-xl animate-pulse"></div>
                            </div>
                            <div class="text-center p-8 glass rounded-2xl h-32 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white/10 rounded-xl animate-pulse"></div>
                            </div>
                            <div class="text-center p-8 glass rounded-2xl h-32 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white/10 rounded-xl animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ðŸ“Š Results Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Live Accounts -->
                    <div class="glass rounded-3xl p-8 shadow-2xl">
                        <div class="flex items-center justify-between mb-8 pb-6 border-b border-white/10">
                            <h3 class="text-2xl font-bold flex items-center gap-3">
                                <i class="fas fa-circle-check text-green-400 text-xl"></i>
                                Live Accounts
                            </h3>
                            <div class="flex gap-3">
                                <a href="/api/export-success/csv" 
                                   class="p-3 bg-green-500/20 hover:bg-green-500/40 text-green-300 rounded-2xl transition-all flex items-center gap-2 font-bold"
                                   download="fedex_live_accounts.csv">
                                    <i class="fas fa-download"></i> CSV
                                </a>
                            </div>
                        </div>
                        <div id="success-results" 
                             class="max-h-96 overflow-y-auto scrollbar-thin space-y-3 pr-4"
                             hx-get="/api/success?limit=8" 
                             hx-trigger="load, every 5s" 
                             hx-swap="innerHTML">
                            <div class="text-center py-20 opacity-50">
                                <i class="fas fa-circle-check text-6xl block mb-4"></i>
                                <div class="text-lg">Loading live accounts...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Invalid -->
                    <div class="glass rounded-3xl p-8 shadow-2xl">
                        <div class="flex items-center justify-between mb-8 pb-6 border-b border-white/10">
                            <h3 class="text-2xl font-bold flex items-center gap-3">
                                <i class="fas fa-circle-xmark text-red-400 text-xl"></i>
                                Invalid Accounts
                            </h3>
                        </div>
                        <div id="invalid-results" 
                             class="max-h-96 overflow-y-auto scrollbar-thin space-y-3 pr-4"
                             hx-get="/api/invalid?limit=8" 
                             hx-trigger="load, every 5s" 
                             hx-swap="innerHTML">
                            <div class="text-center py-20 opacity-50">
                                <i class="fas fa-times-circle text-6xl block mb-4"></i>
                                <div class="text-lg">Loading invalid accounts...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="space-y-8">
                
                <!-- ðŸ“ File Upload -->
                <div class="glass rounded-3xl p-8 shadow-2xl">
                    <h3 class="text-xl font-bold mb-8 flex items-center gap-3">
                        <i class="fas fa-cloud-upload-alt text-blue-400 text-xl"></i>
                        Upload Credentials
                    </h3>
                    <form id="upload-form"
                          hx-post="/api/upload" 
                          hx-target="#upload-result" 
                          hx-swap="innerHTML"
                          enctype="multipart/form-data"
                          class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold mb-3 opacity-90">credentials.txt</label>
                            <input type="file" 
                                   name="file" 
                                   accept=".txt" 
                                   required
                                   class="w-full p-4 rounded-2xl glass border-2 border-dashed border-white/30 hover:border-blue-400/60 text-white placeholder-white/60 focus:outline-none focus:ring-4 focus:ring-blue-400/30 transition-all file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-gradient-to-r file:from-blue-500 file:to-indigo-600 file:text-white">
                        </div>
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-2xl shadow-2xl hover:shadow-3xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3 text-lg">
                            <i class="fas fa-rocket-launch"></i>
                            <span>Upload & Validate</span>
                        </button>
                    </form>
                    <div id="upload-result" class="mt-8 p-6 rounded-2xl glass border-2 border-dashed border-white/20 text-center min-h-[100px] flex flex-col items-center justify-center">
                        <i class="fas fa-file-upload text-4xl text-blue-400 mb-4 opacity-60"></i>
                        <div class="opacity-60">Upload .txt file with format:<br><code>email:password|[name=John][phone=555-1234]</code></div>
                    </div>
                </div>

                <!-- âš¡ Quick Actions -->
                <div class="glass rounded-3xl p-8 shadow-2xl" id="control-panel">
                    <h3 class="text-xl font-bold mb-8 flex items-center gap-3">
                        <i class="fas fa-bolt text-yellow-400 text-xl"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-4">
                        <button class="launch-btn w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-5 px-6 rounded-2xl shadow-2xl hover:shadow-3xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3 text-lg"
                                hx-post="/api/check"
                                hx-vals='js:{filename: document.querySelector("input[type=file]")?.files[0]?.name || "fedex_accounts.txt", num_browsers: 15, start_line: 0}'
                                hx-target="#control-panel"
                                hx-swap="outerHTML">
                            <i class="fas fa-rocket text-xl"></i>
                            <span>ðŸš€ Launch 15 Workers</span>
                        </button>
                        <button class="stop-btn w-full bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white font-bold py-5 px-6 rounded-2xl shadow-2xl hover:shadow-3xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3 text-lg opacity-40"
                                hx-get="/api/stop"
                                hx-target="#control-panel"
                                hx-swap="outerHTML"
                                disabled>
                            <i class="fas fa-stop-circle text-xl"></i>
                            <span>ðŸ›‘ Stop All Workers</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        htmx.config.globalLoadingIndicator = '';
        
        // Transform JSON responses to HTML
        document.body.addEventListener('htmx:beforeSwap', function(e) {
            const targetId = e.target.id;
            let content = e.detail.xhr.responseText;
            
            try {
                const data = JSON.parse(content);
                
                // Status metrics
                if (targetId === 'status-metrics') {
                    content = renderStatusMetrics(data);
                }
                // Success results
                else if (targetId === 'success-results') {
                    content = renderSuccessTable(data.success || []);
                    document.getElementById('success-count').textContent = data.total || 0;
                }
                // Invalid results  
                else if (targetId === 'invalid-results') {
                    content = renderInvalidTable(data.invalid || []);
                    document.getElementById('invalid-count').textContent = data.total || 0;
                }
                // Upload result
                else if (e.target.id === 'upload-result' && data.status) {
                    content = renderUploadResult(data);
                }
                
                e.detail.xhr.responseText = content;
                e.detail.target.innerHTML = content;
            } catch(err) {
                console.log('JSON parse failed, using raw response');
            }
        });

        function renderStatusMetrics(data) {
            const running = data.is_running ? 'ðŸŸ¢ Running' : 'âš« Idle';
            const progress = data.progress_pct ? `${data.progress_pct}%` : '0%';
            const successRate = data.success_rate || '0%';
            
            updateControls(data);
            
            return `
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center p-8 glass rounded-2xl">
                        <div class="text-4xl font-black text-green-400 mb-2">${data.success || 0}</div>
                        <div class="text-sm font-medium opacity-75 uppercase tracking-wider">Live Accounts</div>
                    </div>
                    <div class="text-center p-8 glass rounded-2xl">
                        <div class="text-4xl font-black text-red-400 mb-2">${data.invalid || 0}</div>
                        <div class="text-sm font-medium opacity-75 uppercase tracking-wider">Invalid</div>
                    </div>
                    <div class="text-center p-8 glass rounded-2xl">
                        <div class="text-4xl font-black text-blue-400 mb-2">${progress}</div>
                        <div class="text-sm font-medium opacity-75 uppercase tracking-wider">Progress</div>
                    </div>
                    <div class="text-center p-8 glass rounded-2xl">
                        <div class="text-4xl font-black text-orange-400 mb-2">${data.total_shipments || 0}</div>
                        <div class="text-sm font-medium opacity-75 uppercase tracking-wider">Total Shipments</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 border-t border-white/10">
                    <div class="p-6 glass rounded-2xl text-center">
                        <div class="text-lg font-bold">${data.current_file || 'No file'}</div>
                        <div class="text-sm opacity-75">${data.total_logins || 0} total creds</div>
                    </div>
                    <div class="p-6 glass rounded-2xl text-center">
                        <div class="text-lg font-bold">${data.elapsed || '00:00'}</div>
                        <div class="text-sm opacity-75">${running}</div>
                    </div>
                    <div class="p-6 glass rounded-2xl text-center">
                        <div class="text-lg font-bold text-green-400">${successRate}</div>
                        <div class="text-sm opacity-75">Success Rate</div>
                    </div>
                </div>
            `;
        }

        function renderSuccessTable(accounts) {
            if (!accounts.length) {
                return `
                    <div class="text-center py-20 opacity-50">
                        <i class="fas fa-circle-check text-6xl block mb-4"></i>
                        <div class="text-lg">No live accounts yet</div>
                        <div class="text-sm mt-2">Upload credentials to start checking</div>
                    </div>
                `;
            }
            
            return accounts.map(account => `
                <div class="success-row p-4 rounded-2xl hover:bg-white/10 transition-all group">
                    <div class="flex flex-col space-y-1 flex-1 min-w-0">
                        <div class="font-bold text-sm truncate">${account.user_id}</div>
                        <div class="text-xs opacity-75 truncate">${account.password}</div>
                        ${account.name ? `<div class="text-xs opacity-60">${account.name}</div>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg text-green-400">${account.total_shipments || 0}</div>
                        <div class="text-xs opacity-75 flex items-center justify-end gap-1">
                            <i class="fas fa-truck"></i> shipments
                        </div>
                        ${account.has_shipments ? '<div class="text-xs bg-green-500/30 text-green-300 px-2 py-1 rounded-full mt-1 font-bold">ACTIVE</div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderInvalidTable(accounts) {
            if (!accounts.length) {
                return `
                    <div class="text-center py-20 opacity-50">
                        <i class="fas fa-times-circle text-6xl block mb-4"></i>
                        <div class="text-lg">No invalid accounts</div>
                    </div>
                `;
            }
            
            return accounts.slice(0, 8).map(account => `
                <div class="invalid-row p-4 rounded-xl hover:bg-white/10 transition-all">
                    <div class="flex flex-col space-y-1 flex-1 min-w-0">
                        <div class="font-bold text-sm truncate">${account.user_id}</div>
                        <div class="text-xs opacity-75 truncate">${account.password || '****'}</div>
                    </div>
                    <div class="text-right text-xs opacity-75">
                        ${account.error ? account.error.slice(0, 30) + '...' : account.login_status}
                    </div>
                </div>
            `).join('');
        }

        function renderUploadResult(data) {
            if (data.status === 'success') {
                return `
                    <div class="flex items-center gap-3 p-6 bg-emerald-500/20 rounded-2xl border-2 border-emerald-400/40">
                        <i class="fas fa-check-circle text-2xl text-emerald-400"></i>
                        <div>
                            <div class="font-bold text-lg">${data.filename}</div>
                            <div class="text-sm opacity-90">${data.total_creds || 0} valid credentials</div>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="flex items-center gap-3 p-6 bg-red-500/20 rounded-2xl border-2 border-red-400/40">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                    <div>${data.message || 'Upload failed'}</div>
                </div>
            `;
        }

        function updateControls(status) {
            const launchBtn = document.querySelector('.launch-btn');
            const stopBtn = document.querySelector('.stop-btn');
            
            if (status?.is_running) {
                if (launchBtn) {
                    launchBtn.disabled = true;
                    launchBtn.style.opacity = '0.4';
                }
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.style.opacity = '1';
                }
            } else {
                if (launchBtn) {
                    launchBtn.disabled = false;
                    launchBtn.style.opacity = '1';
                }
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.style.opacity = '0.4';
                }
            }
        }

        // Success sound effect
        document.body.addEventListener('htmx:afterSwap', function(e) {
            if (e.target.id === 'success-results') {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        });

        // Toast notifications
        document.body.addEventListener('htmx:afterRequest', function(e) {
            if (e.detail.successful) {
                if (e.target.matches('#upload-form button')) {
                    showToast('âœ… File uploaded successfully!', 'success');
                }
                if (e.target.classList.contains('launch-btn')) {
                    showToast('ðŸš€ Workers launched! Monitoring live...', 'success');
                }
            }
        });

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-6 right-6 z-50 p-6 rounded-3xl shadow-3xl transform translate-x-full transition-all duration-300 text-white font-bold flex items-center gap-3 max-w-sm backdrop-blur-xl ${
                type === 'success' ? 'bg-emerald-500/95 border border-emerald-400/50' : 'bg-blue-500/95 border border-blue-400/50'
            }`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} text-xl"></i>${message}`;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // File input preview
        document.getElementById('upload-form').onsubmit = function() {
            const fileInput = this.querySelector('input[type=file]');
            if (fileInput.files[0]) {
                showToast(`Uploading ${fileInput.files[0].name}...`, 'info');
            }
        };
    </script>
</body>
</html>
